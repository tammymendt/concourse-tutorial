---
resource_types    :
  - name          : pull-request
    type          : docker-image
    source        :
      repository  : jtarchie/pr

resources:
  - name: super-app
    type: pull-request
    source:
      repo: tammymendt/concourse-tutorial
      access_token: {{github_token}}

  - name: release-rc
    type: github-release
    source:
      user: tammymendt
      repository: concourse-tutorial
      access_token: {{github_token}}
      pre_release: True

jobs:
  - name: PR unit testing
    plan:
    - get: super-app
      trigger: true

    - put: super-app
      params: {path: super-app, context: Unit Tests, status: pending}

    - task: run unit
      file: super-app/tutorial/scenario.3/1-pr/tasks/unit.yml

      on_success:
        put: super-app
        params: {path: super-app, context: Unit Tests, status: success}

      on_failure:
        put: super-app
        params: {path: super-app, context: Unit Tests, status: failure}

  - name: PR building & integration testing
    plan:
    - get: super-app
      passed: ["PR unit testing"]
      trigger: true

    - task: build
      file: super-app/tutorial/scenario.3/1-pr/tasks/build.yml

    - task: integeration test
      file: super-app/tutorial/scenario.3/1-pr/tasks/integration.yml

  - name: Master build
    plan:
    - get: super-app
      passed: ["PR building & integration testing"]
      trigger: true
    - aggregate:
      - task: build linux
        file: super-app/tutorial/scenario.4/1-multi-os/tasks/build_linux.yml

      - task: build darwin
        file: super-app/tutorial/scenario.4/1-multi-os/tasks/build_darwin.yml

      - task: build windows
        file: super-app/tutorial/scenario.4/1-multi-os/tasks/build_windows.yml

    - put: release-rc
      params:
        name: super-app/tutorial/scenario.4/2-releases/version
        tag : super-app/tutorial/scenario.4/2-releases/version
        tag_prefix: v
        globs:
          - artifact_linux/super_*_linux_amd64
          - artifact_windows/super_*_windows_amd64
          - artifact_darwin/super_*_darwin_amd64